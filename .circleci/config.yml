# CircleCI Configuration for INSY7314_SecurePay
# This file tells CircleCI what to do.

version: 2.1

# Import the official SonarSource "orb" 
orbs:
  sonar-scan: sonarsource/sonar-scan@2.1.0

# Define the job that will run
jobs:
  build-and-scan:
    # Use a standard Node.js environment
    executor: cimg/node:18.0
    
    steps:
      # Step 1: Get the code from GitHub
      - checkout

      # Step 2: Install all project dependencies (from your root package.json)
      - run:
          name: "Install Dependencies"
          command: npm install

      # Step 3: Run the SonarCloud scan!
      - sonar-scan/scan:
          # These keys are read from the CircleCI Environment Variables
          # which you will add in the next step.
          sonar_token: $SONAR_TOKEN
          project_key: $SONAR_PROJECT_KEY
          organization: $SONAR_ORGANIZATION
          
          # This tells the scanner where your actual source code is
          project_sources: "src/react-app, src/server"
          
          # A friendly name for the SonarCloud dashboard
          project_name: "INSY7314_SecurePay"

# Define the workflow (how and when to run the job)
workflows:
  main-workflow:
    jobs:
      - build-and-scan:
          # This filter tells the job to run on the 'main' branch
          # AND on this new branch, so we can test it right now.
          filters:
            branches:
              only:
                - main
                - circleci-project-setup