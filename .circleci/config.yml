# CircleCI Configuration for INSY7314_SecurePay
# This file tells CircleCI what to do.

version: 2.1

# Import the official SonarSource "orb" 
orbs:
  sonar-scan: sonarsource/sonar-scan@3.0.1

# Define the job that will run
jobs:
  build-and-scan:
    # Use a standard Node.js environment via Docker image
    docker:
      - image: cimg/node:18.0
    working_directory: ~/repo

    steps:
      # Step 1: Get the code from GitHub
      - checkout

      # Step 2: Install all project dependencies (from your root package.json)
      - run:
          name: "Install Dependencies"
          command: npm install

      # Step 3: Run the SonarQube scan
      - sonar-scan/scan:
          # These values are read from the CircleCI environment (project settings or contexts)
          sonar_token: $SONAR_TOKEN
          project_key: $SONAR_PROJECT_KEY
          # For self-hosted SonarQube, set SONAR_HOST_URL (e.g. https://sonarqube.example.com)
          sonar_host_url: $SONAR_HOST_URL
          # Where your source lives relative to repo root
          project_sources: "src/react-app, src/server"
          project_name: "INSY7314_SecurePay"

# Define the workflow (how and when to run the job)
workflows:
  main-workflow:
    jobs:
      - build-and-scan:
          # This filter tells the job to run on the 'main' branch
          # AND on this new branch, so we can test it right now.
          filters:
            branches:
              only:
                - main
                - circleci-project-setup